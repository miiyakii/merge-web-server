<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯ä¹¦æ‰¹é‡ç”Ÿæˆç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
        const { useState } = React;
        const { createElement: h } = React;

        // å›¾æ ‡ç»„ä»¶åº“
        const Icons = {
            Upload: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2,
                strokeLinecap: 'round', strokeLinejoin: 'round'
            },
                h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                h('polyline', { points: '17 8 12 3 7 8' }),
                h('line', { x1: '12', y1: '3', x2: '12', y2: '15' })
            ),
            FileSpreadsheet: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
                h('polyline', { points: '14 2 14 8 20 8' }),
                h('line', { x1: '16', y1: '13', x2: '8', y2: '13' }),
                h('line', { x1: '16', y1: '17', x2: '8', y2: '17' }),
                h('polyline', { points: '10 9 9 9 8 9' })
            ),
            Download: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                h('polyline', { points: '7 10 12 15 17 10' }),
                h('line', { x1: '12', y1: '15', x2: '12', y2: '3' })
            ),
            CheckCircle: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
                h('polyline', { points: '22 4 12 14.01 9 11.01' })
            ),
            AlertCircle: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('circle', { cx: '12', cy: '12', r: '10' }),
                h('line', { x1: '12', y1: '8', x2: '12', y2: '12' }),
                h('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' })
            ),
            FileText: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
                h('polyline', { points: '14 2 14 8 20 8' }),
                h('line', { x1: '16', y1: '13', x2: '8', y2: '13' }),
                h('line', { x1: '16', y1: '17', x2: '8', y2: '17' }),
                h('line', { x1: '10', y1: '9', x2: '8', y2: '9' })
            ),
            Layers: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('polygon', { points: '12 2 2 7 12 12 22 7 12 2' }),
                h('polyline', { points: '2 17 12 22 22 17' }),
                h('polyline', { points: '2 12 12 17 22 12' })
            ),
            Wand2: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('path', { d: 'M15 4V2' }),
                h('path', { d: 'M15 16v-2' }),
                h('path', { d: 'M8 9h2' }),
                h('path', { d: 'M20 9h2' }),
                h('path', { d: 'M17.8 11.8 19 13' }),
                h('path', { d: 'M15 9h0' }),
                h('path', { d: 'M17.8 6.2 19 5' }),
                h('path', { d: 'm3 21 9-9' }),
                h('path', { d: 'M12.2 6.2 11 5' })
            ),
            Settings: ({ size = 20, className = '' }) => h('svg', {
                className, width: size, height: size, viewBox: '0 0 24 24',
                fill: 'none', stroke: 'currentColor', strokeWidth: 2
            },
                h('circle', { cx: '12', cy: '12', r: '3' }),
                h('path', { d: 'M12 1v6m0 6v6' }),
                h('path', { d: 'm1 12 6 0m6 0 6 0' })
            )
        };

        function CertificateGenerator() {
            const [step, setStep] = useState(1);
            const [files, setFiles] = useState([]);
            const [fileType, setFileType] = useState('');
            const [sheets, setSheets] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState({});
            const [allNames, setAllNames] = useState([]);
            const [enableDedup, setEnableDedup] = useState(true);
            const [duplicateWarning, setDuplicateWarning] = useState(null);
            const [generating, setGenerating] = useState(false);
            const [error, setError] = useState('');
            const [manualMode, setManualMode] = useState(false);

            const handleTxtUpload = (e) => {
                const uploadedFile = e.target.files[0];
                if (!uploadedFile) return;
                setFiles([uploadedFile]);
                setFileType('txt');
                setError('');
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const names = text.split(/[\r\n]+/).map(line => line.trim()).filter(line => line !== '');
                        if (names.length === 0) {
                            setError('TXTæ–‡ä»¶ä¸ºç©ºï¼Œè¯·ä¸Šä¼ åŒ…å«å§“åçš„æ–‡ä»¶');
                            return;
                        }
                        const nameCount = {};
                        names.forEach(name => {
                            nameCount[name] = (nameCount[name] || 0) + 1;
                        });
                        const duplicates = Object.entries(nameCount).filter(([name, count]) => count > 1).map(([name, count]) => ({ name, count }));
                        if (duplicates.length > 0) {
                            setDuplicateWarning({
                                total: names.length,
                                unique: Object.keys(nameCount).length,
                                duplicates: duplicates
                            });
                        } else {
                            setDuplicateWarning(null);
                        }
                        const finalNames = enableDedup ? [...new Set(names)] : names;
                        setAllNames(finalNames);
                        setStep(3);
                    } catch (err) {
                        setError('è¯»å–TXTæ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
                        console.error(err);
                    }
                };
                reader.readAsText(uploadedFile, 'UTF-8');
            };

            const handleFileUpload = async (e) => {
                const uploadedFiles = Array.from(e.target.files);
                if (uploadedFiles.length === 0) return;
                setFiles(uploadedFiles);
                setFileType('excel');
                setError('');
                try {
                    const allSheetsData = [];
                    for (let fileIndex = 0; fileIndex < uploadedFiles.length; fileIndex++) {
                        const file = uploadedFiles[fileIndex];
                        const fileName = file.name.replace(/\.(xlsx|xls)$/i, '');
                        const data = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (event) => resolve(new Uint8Array(event.target.result));
                            reader.onerror = reject;
                            reader.readAsArrayBuffer(file);
                        });
                        const workbook = XLSX.read(data, { type: 'array' });
                        if (workbook.SheetNames.length === 0) continue;
                        const fileSheets = workbook.SheetNames.map(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const nameKeywords = ['å§“å', 'name', 'åå­—', 'åç§°', 'å­¦ç”Ÿå§“å', 'å­¦ç”Ÿ', 'äººå‘˜', 'å‘˜å·¥'];
                            let bestData = null, bestColumns = [], bestNameCol = '', bestScore = 0;
                            for (let startRow = 0; startRow <= 2; startRow++) {
                                try {
                                    const jsonData = startRow === 0 ? XLSX.utils.sheet_to_json(worksheet) : XLSX.utils.sheet_to_json(worksheet, { range: startRow });
                                    if (jsonData.length === 0) continue;
                                    const columns = Object.keys(jsonData[0]);
                                    let score = 0, matchedCol = '';
                                    for (const col of columns) {
                                        if (nameKeywords.some(keyword => col.toLowerCase().includes(keyword.toLowerCase()))) {
                                            score += 100;
                                            matchedCol = col;
                                            break;
                                        }
                                    }
                                    const validCols = columns.filter(col => !col.startsWith('_EMPTY'));
                                    score += validCols.length * 10;
                                    const firstRowValues = Object.values(jsonData[0]);
                                    const nonEmptyValues = firstRowValues.filter(v => v !== null && v !== undefined && v !== '');
                                    score += (nonEmptyValues.length / firstRowValues.length) * 20;
                                    if (score > bestScore) {
                                        bestScore = score;
                                        bestData = jsonData;
                                        bestColumns = columns;
                                        bestNameCol = matchedCol;
                                    }
                                } catch (e) { continue; }
                            }
                            if (!bestNameCol && bestData && bestData.length > 0) {
                                for (const col of bestColumns) {
                                    const sampleValues = bestData.slice(0, 10).map(row => row[col]).filter(v => v);
                                    if (sampleValues.length > 0) {
                                        const likeNameCount = sampleValues.filter(val => {
                                            const str = String(val).trim();
                                            return str.length >= 2 && str.length <= 6 && /[\u4e00-\u9fa5]/.test(str);
                                        }).length;
                                        if (likeNameCount / sampleValues.length > 0.7) {
                                            bestNameCol = col;
                                            break;
                                        }
                                    }
                                }
                            }
                            return {
                                fileName: fileName,
                                name: sheetName,
                                displayName: uploadedFiles.length > 1 ? `${fileName} - ${sheetName}` : sheetName,
                                data: bestData || [],
                                columns: bestColumns,
                                nameColumn: bestNameCol,
                                autoDetected: !!bestNameCol,
                                isEmpty: !bestData || bestData.length === 0
                            };
                        });
                        allSheetsData.push(...fileSheets);
                    }
                    if (allSheetsData.length === 0) {
                        setError('æ‰€æœ‰Excelæ–‡ä»¶éƒ½ä¸ºç©º');
                        return;
                    }
                    setSheets(allSheetsData);
                    const initialSelected = {};
                    let allDetected = true;
                    let hasEmptySheets = false;
                    allSheetsData.forEach((sheet, idx) => {
                        const shouldSelect = !sheet.isEmpty;
                        initialSelected[idx] = { selected: shouldSelect, nameColumn: sheet.nameColumn };
                        if (!sheet.nameColumn && !sheet.isEmpty) allDetected = false;
                        if (sheet.isEmpty) hasEmptySheets = true;
                    });
                    setSelectedSheets(initialSelected);
                    setManualMode(!allDetected);
                    let errorMsg = '';
                    if (!allDetected) errorMsg = 'éƒ¨åˆ†Sheetæ— æ³•è‡ªåŠ¨è¯†åˆ«å§“ååˆ—ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©';
                    if (hasEmptySheets) {
                        const emptySheetNames = allSheetsData.filter(s => s.isEmpty).map(s => s.displayName).join('ã€');
                        errorMsg += (errorMsg ? 'ï¼›' : '') + `æ£€æµ‹åˆ°ç©ºSheetï¼ˆ${emptySheetNames}ï¼‰ï¼Œå·²è‡ªåŠ¨å–æ¶ˆé€‰ä¸­`;
                    }
                    if (errorMsg) setError(errorMsg);
                    setStep(2);
                } catch (err) {
                    setError('è¯»å–Excelæ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
                    console.error(err);
                }
            };

            const toggleSheetSelection = (idx) => {
                setSelectedSheets(prev => ({ ...prev, [idx]: { ...prev[idx], selected: !prev[idx].selected } }));
            };

            const updateNameColumn = (idx, column) => {
                setSelectedSheets(prev => ({ ...prev, [idx]: { ...prev[idx], nameColumn: column } }));
            };

            const handleExtractAll = () => {
                const extractedNames = [], errors = [], skippedEmptySheets = [];
                sheets.forEach((sheet, idx) => {
                    const sheetConfig = selectedSheets[idx];
                    if (!sheetConfig.selected) return;
                    if (sheet.isEmpty || sheet.data.length === 0) {
                        skippedEmptySheets.push(sheet.displayName || sheet.name);
                        return;
                    }
                    if (!sheetConfig.nameColumn) {
                        errors.push(`Sheet "${sheet.displayName || sheet.name}" æœªé€‰æ‹©å§“ååˆ—`);
                        return;
                    }
                    const names = sheet.data.map(row => row[sheetConfig.nameColumn]).filter(name => name && name.toString().trim() !== '').map(name => name.toString().trim());
                    extractedNames.push(...names);
                });
                if (errors.length > 0) {
                    setError(errors.join('ï¼›'));
                    return;
                }
                if (extractedNames.length === 0) {
                    if (skippedEmptySheets.length > 0) {
                        setError(`æ‰€æœ‰é€‰ä¸­çš„Sheetéƒ½æ˜¯ç©ºçš„ï¼š${skippedEmptySheets.join('ã€')}`);
                    } else {
                        setError('æ²¡æœ‰æå–åˆ°ä»»ä½•å§“åï¼Œè¯·æ£€æŸ¥é€‰æ‹©çš„åˆ—');
                    }
                    return;
                }
                const nameCount = {};
                extractedNames.forEach(name => { nameCount[name] = (nameCount[name] || 0) + 1; });
                const duplicates = Object.entries(nameCount).filter(([name, count]) => count > 1).map(([name, count]) => ({ name, count }));
                if (duplicates.length > 0) {
                    setDuplicateWarning({ total: extractedNames.length, unique: Object.keys(nameCount).length, duplicates: duplicates });
                } else {
                    setDuplicateWarning(null);
                }
                const finalNames = enableDedup ? [...new Set(extractedNames)] : extractedNames;
                setAllNames(finalNames);
                setError('');
                if (skippedEmptySheets.length > 0) {
                    setError(`å·²è·³è¿‡ç©ºSheetï¼š${skippedEmptySheets.join('ã€')}`);
                }
                setStep(3);
            };

            const downloadNamesAsTxt = () => {
                const txtContent = allNames.join('\n');
                const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'å§“ååˆ—è¡¨.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            };

            const handleGenerate = async () => {
                setGenerating(true);
                setError('');
                try {
                    const response = await fetch(__API_URL__ + '/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ names: allNames })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                    }
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'è¯ä¹¦åˆé›†.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    setStep(4);
                } catch (err) {
                    setError(err.message);
                    console.error(err);
                } finally {
                    setGenerating(false);
                }
            };

            const selectedCount = Object.values(selectedSheets).filter(s => s.selected).length;
            const autoDetectedCount = sheets.filter(s => s.autoDetected).length;

            return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8' },
                h('div', { className: 'max-w-4xl mx-auto' },
                    h('div', { className: 'text-center mb-8' },
                        h('h1', { className: 'text-4xl font-bold text-gray-800 mb-2' }, 'ğŸ“œ è¯ä¹¦æ‰¹é‡ç”Ÿæˆç³»ç»Ÿ'),
                        h('p', { className: 'text-gray-600' }, 'æ™ºèƒ½è¯†åˆ« + æ‰‹åŠ¨è°ƒæ•´ï¼Œæ”¯æŒå¤šSheet Excelå’ŒTXT')
                    ),
                    h('div', { className: 'flex justify-center mb-8' },
                        [1, 2, 3, 4].map((s) => h('div', { key: s, className: 'flex items-center' },
                            h('div', { className: `w-10 h-10 rounded-full flex items-center justify-center font-bold ${step >= s ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-600'}` }, s),
                            s < 4 && h('div', { className: `w-16 h-1 ${step > s ? 'bg-indigo-600' : 'bg-gray-300'}` })
                        ))
                    ),
                    error && h('div', { className: 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start' },
                        h(Icons.AlertCircle, { size: 20, className: 'text-red-500 mr-3 mt-0.5 flex-shrink-0' }),
                        h('p', { className: 'text-red-700' }, error)
                    ),
                    h('div', { className: 'bg-white rounded-xl shadow-lg p-8' },
                        step === 1 && h('div', { className: 'text-center' },
                            h(Icons.FileSpreadsheet, { size: 64, className: 'mx-auto mb-4 text-indigo-600' }),
                            h('h2', { className: 'text-2xl font-bold mb-4' }, 'ä¸Šä¼ æ–‡ä»¶'),
                            h('p', { className: 'text-gray-600 mb-6' }, 'æ”¯æŒå¤šä¸ªExcelæ–‡ä»¶ï¼ˆå¤šSheetæ™ºèƒ½è¯†åˆ«ï¼‰æˆ–å•ä¸ªTXTæ–‡æœ¬ï¼ˆæ¯è¡Œä¸€ä¸ªå§“åï¼‰'),
                            h('div', { className: 'flex gap-4 justify-center mb-4' },
                                h('label', { className: 'inline-block cursor-pointer' },
                                    h('div', { className: 'px-6 py-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center' },
                                        h(Icons.FileSpreadsheet, { size: 20, className: 'mr-2' }),
                                        'ä¸Šä¼ Excelæ–‡ä»¶'
                                    ),
                                    h('input', { type: 'file', accept: '.xlsx,.xls', onChange: handleFileUpload, multiple: true, className: 'hidden' })
                                ),
                                h('label', { className: 'inline-block cursor-pointer' },
                                    h('div', { className: 'px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center' },
                                        h(Icons.FileText, { size: 20, className: 'mr-2' }),
                                        'ä¸Šä¼ TXTæ–‡ä»¶'
                                    ),
                                    h('input', { type: 'file', accept: '.txt', onChange: handleTxtUpload, className: 'hidden' })
                                )
                            ),
                            files.length > 0 && h('div', { className: 'mt-4' },
                                h('p', { className: 'text-sm text-gray-600 mb-2' }, 'å·²é€‰æ‹©: ', h('span', { className: 'font-semibold' }, files.length === 1 ? files[0].name : `${files.length} ä¸ªæ–‡ä»¶`)),
                                files.length > 1 && h('div', { className: 'text-xs text-gray-500 space-y-1' },
                                    files.map((f, idx) => h('div', { key: idx }, `${idx + 1}. ${f.name}`))
                                ),
                                h('p', { className: 'text-xs text-gray-500 mt-1' }, 'æ–‡ä»¶ç±»å‹: ', fileType === 'excel' ? `Excelè¡¨æ ¼ (${files.length}ä¸ª)` : 'TXTæ–‡æœ¬')
                            ),
                            h('div', { className: 'mt-6 p-4 bg-blue-50 rounded-lg text-left' },
                                h('p', { className: 'text-sm font-semibold text-blue-900 mb-2' }, 'ğŸ“ æ–‡ä»¶æ ¼å¼è¦æ±‚'),
                                h('div', { className: 'text-xs text-blue-800 space-y-1' },
                                    h('p', {}, h('strong', {}, 'Excelï¼š'), 'æ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ªExcelæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯åŒ…å«å¤šä¸ªSheet'),
                                    h('p', {}, h('strong', {}, 'TXTï¼š'), 'æ¯è¡Œä¸€ä¸ªå§“åï¼Œä¾‹å¦‚ï¼š'),
                                    h('pre', { className: 'bg-white p-2 rounded mt-1 text-gray-700' }, 'å¼ ä¸‰\næå››\nç‹äº”')
                                )
                            )
                        ),
                        step === 2 && h('div', {},
                            h('div', { className: 'flex items-center justify-between mb-4' },
                                h('h2', { className: 'text-2xl font-bold' }, 'é…ç½®å·¥ä½œè¡¨'),
                                h('div', { className: 'flex items-center gap-3' },
                                    h('button', {
                                        onClick: () => setManualMode(!manualMode),
                                        className: 'flex items-center gap-2 px-4 py-2 border border-indigo-300 rounded-lg hover:bg-indigo-50 transition text-sm'
                                    },
                                        manualMode ? [h(Icons.Wand2, { key: 'icon', size: 16 }), h('span', { key: 'text' }, 'æ™ºèƒ½æ¨¡å¼')] : [h(Icons.Settings, { key: 'icon', size: 16 }), h('span', { key: 'text' }, 'æ‰‹åŠ¨æ¨¡å¼')]
                                    ),
                                    h('div', { className: 'text-sm text-gray-600' }, `${selectedCount} / ${sheets.length} ä¸ªSheet`, files.length > 1 && h('span', { className: 'ml-2 text-xs' }, `(${files.length}ä¸ªæ–‡ä»¶)`))
                                )
                            ),
                            !manualMode && h('div', { className: 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg' },
                                h('div', { className: 'flex items-start' },
                                    h(Icons.Wand2, { size: 20, className: 'text-green-600 mr-3 mt-0.5 flex-shrink-0' }),
                                    h('div', {},
                                        h('p', { className: 'font-semibold text-green-800 mb-1' }, 'æ™ºèƒ½è¯†åˆ«ç»“æœ'),
                                        h('p', { className: 'text-sm text-green-700' }, `å·²è‡ªåŠ¨è¯†åˆ« ${autoDetectedCount}/${sheets.length} ä¸ªSheetçš„å§“ååˆ—`, autoDetectedCount < sheets.length && h('span', { className: 'text-red-600' }, ' Â· éƒ¨åˆ†Sheetéœ€è¦æ‰‹åŠ¨è°ƒæ•´'))
                                    )
                                )
                            ),
                            h('div', { className: 'space-y-4 mb-6 max-h-[500px] overflow-y-auto' },
                                sheets.map((sheet, idx) => {
                                    const config = selectedSheets[idx];
                                    const hasNameColumn = config?.nameColumn;
                                    const isEmpty = sheet.isEmpty;
                                    return h('div', {
                                        key: idx,
                                        className: `border rounded-lg p-4 transition ${isEmpty ? 'border-gray-300 bg-gray-100 opacity-60' : config?.selected ? hasNameColumn ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50' : 'border-gray-200 bg-gray-50'}`
                                    },
                                        h('div', { className: 'flex items-start' },
                                            h('input', {
                                                type: 'checkbox',
                                                checked: config?.selected || false,
                                                onChange: () => toggleSheetSelection(idx),
                                                disabled: isEmpty,
                                                className: `mt-1 mr-3 w-5 h-5 text-indigo-600 rounded ${isEmpty ? 'opacity-50 cursor-not-allowed' : ''}`
                                            }),
                                            h('div', { className: 'flex-1' },
                                                h('div', { className: 'flex items-center mb-3' },
                                                    h(Icons.Layers, { size: 18, className: 'text-indigo-600 mr-2' }),
                                                    h('h3', { className: 'font-bold text-lg' }, sheet.displayName || sheet.name),
                                                    isEmpty && h('span', { className: 'ml-2 px-2 py-1 bg-gray-400 text-white text-xs rounded-full' }, 'ç©ºè¡¨'),
                                                    sheet.autoDetected && !manualMode && !isEmpty && h('span', { className: 'ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded-full' }, 'âœ“ å·²è¯†åˆ«'),
                                                    !hasNameColumn && config?.selected && !isEmpty && h('span', { className: 'ml-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full' }, '! éœ€è®¾ç½®'),
                                                    h('span', { className: 'ml-auto text-sm text-gray-600' }, `${sheet.data.length} è¡Œ`)
                                                ),
                                                isEmpty && h('p', { className: 'text-sm text-gray-500 italic mb-3' }, 'â„¹ï¸ æ­¤Sheetæ— æ•°æ®ï¼Œæ— æ³•é€‰æ‹©'),
                                                config?.selected && !isEmpty && [
                                                    !manualMode && hasNameColumn && h('div', { key: 'auto', className: 'mb-3 p-3 bg-white rounded border border-green-200' },
                                                        h('p', { className: 'text-sm' }, h('span', { className: 'font-semibold text-gray-700' }, 'å§“ååˆ—ï¼š'), h('span', { className: 'text-green-700 font-bold' }, config.nameColumn))
                                                    ),
                                                    (manualMode || !hasNameColumn) && h('div', { key: 'manual', className: 'mb-3' },
                                                        h('label', { className: 'block text-sm font-semibold mb-2' }, 'å§“ååˆ—'),
                                                        h('select', {
                                                            value: config?.nameColumn || '',
                                                            onChange: (e) => updateNameColumn(idx, e.target.value),
                                                            className: 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent'
                                                        }, h('option', { value: '' }, '-- è¯·é€‰æ‹© --'), sheet.columns.map(col => h('option', { key: col, value: col }, col)))
                                                    ),
                                                    sheet.data.length > 0 && h('div', { key: 'preview' },
                                                        h('p', { className: 'text-xs font-semibold text-gray-600 mb-2' }, 'æ•°æ®é¢„è§ˆï¼ˆå‰3è¡Œï¼‰'),
                                                        h('div', { className: 'overflow-x-auto border rounded bg-white' },
                                                            h('table', { className: 'w-full text-xs' },
                                                                h('thead', { className: 'bg-gray-50' },
                                                                    h('tr', {},
                                                                        sheet.columns.slice(0, 5).map(col => h('th', { key: col, className: 'px-3 py-1 text-left font-semibold' }, col, col === config?.nameColumn && h('span', { className: 'ml-1 text-green-600' }, 'â˜…'))),
                                                                        sheet.columns.length > 5 && h('th', { className: 'px-3 py-1 text-left text-gray-400' }, '...')
                                                                    )
                                                                ),
                                                                h('tbody', {},
                                                                    sheet.data.slice(0, 3).map((row, rowIdx) => h('tr', { key: rowIdx, className: 'border-t' },
                                                                        sheet.columns.slice(0, 5).map(col => h('td', { key: col, className: `px-3 py-1 ${col === config?.nameColumn ? 'bg-green-50 font-semibold' : ''}` }, row[col])),
                                                                        sheet.columns.length > 5 && h('td', { className: 'px-3 py-1 text-gray-400' }, '...')
                                                                    ))
                                                                )
                                                            )
                                                        )
                                                    )
                                                ]
                                            )
                                        )
                                    );
                                })
                            ),
                            h('div', { className: 'flex space-x-4' },
                                h('button', { onClick: () => setStep(1), className: 'px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition' }, 'ä¸Šä¸€æ­¥'),
                                h('button', { onClick: handleExtractAll, disabled: selectedCount === 0, className: 'flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400' }, 'æå–æ‰€æœ‰å§“å')
                            ),
                            h('div', { className: 'mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg' },
                                h('label', { className: 'flex items-center cursor-pointer' },
                                    h('input', { type: 'checkbox', checked: enableDedup, onChange: (e) => setEnableDedup(e.target.checked), className: 'w-4 h-4 text-indigo-600 rounded mr-3' }),
                                    h('div', {},
                                        h('span', { className: 'font-semibold text-blue-900' }, 'è‡ªåŠ¨å»é‡ï¼ˆæ¨èï¼‰'),
                                        h('p', { className: 'text-xs text-blue-700 mt-1' }, 'å¦‚æœæœ‰é‡åå­¦ç”Ÿï¼Œåªä¸ºå…¶ç”Ÿæˆä¸€å¼ è¯ä¹¦ã€‚å–æ¶ˆå‹¾é€‰å°†ä¸ºæ¯ä¸ªå§“åç”Ÿæˆç‹¬ç«‹è¯ä¹¦ï¼ˆå³ä½¿é‡åï¼‰ã€‚')
                                    )
                                )
                            )
                        ),
                        step === 3 && h('div', {},
                            h('h2', { className: 'text-2xl font-bold mb-4' }, 'ç¡®è®¤å§“ååˆ—è¡¨'),
                            h('div', { className: 'flex items-center gap-2 mb-4' },
                                h('p', { className: 'text-gray-600' },
                                    fileType === 'excel' ? `ä» ${selectedCount} ä¸ªSheetä¸­æå–åˆ°` : 'ä»TXTæ–‡ä»¶ä¸­æå–åˆ°',
                                    h('span', { className: 'font-bold text-indigo-600' }, ` ${allNames.length} `),
                                    `ä¸ª${enableDedup ? 'å”¯ä¸€' : ''}å§“å`
                                ),
                                files.length > 0 && h('span', { className: 'text-xs text-gray-500' }, `(${files.length === 1 ? files[0].name : `${files.length}ä¸ªæ–‡ä»¶`})`)
                            ),
                            duplicateWarning && duplicateWarning.duplicates.length > 0 && h('div', { className: `mb-6 p-4 border rounded-lg ${enableDedup ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-300'}` },
                                h('div', { className: 'flex items-start mb-3' },
                                    h(Icons.AlertCircle, { size: 20, className: `${enableDedup ? 'text-yellow-600' : 'text-blue-600'} mr-3 mt-0.5 flex-shrink-0` }),
                                    h('div', { className: 'flex-1' },
                                        h('p', { className: `font-semibold ${enableDedup ? 'text-yellow-900' : 'text-blue-900'} mb-1` }, enableDedup ? 'âš ï¸ æ£€æµ‹åˆ°é‡åï¼ˆå·²è‡ªåŠ¨å»é‡ï¼‰' : 'â„¹ï¸ æ£€æµ‹åˆ°é‡å'),
                                        h('p', { className: `text-sm ${enableDedup ? 'text-yellow-800' : 'text-blue-800'} mb-2` },
                                            `åŸå§‹æ•°æ®å…± `, h('strong', {}, duplicateWarning.total), ` æ¡ï¼Œå”¯ä¸€å§“å `, h('strong', {}, duplicateWarning.unique), ` ä¸ªï¼Œ${enableDedup ? 'å»é‡å' : ''}å°†ç”Ÿæˆ `, h('strong', {}, allNames.length), ` å¼ è¯ä¹¦`
                                        ),
                                        h('div', { className: `text-xs ${enableDedup ? 'text-yellow-700' : 'text-blue-700'} space-y-1` },
                                            h('p', { className: 'font-semibold' }, 'é‡ååˆ—è¡¨ï¼š'),
                                            h('div', { className: 'flex flex-wrap gap-2 mt-2' },
                                                duplicateWarning.duplicates.slice(0, 10).map((dup, idx) =>
                                                    h('span', { key: idx, className: `px-2 py-1 ${enableDedup ? 'bg-yellow-100' : 'bg-blue-100'} rounded text-xs` }, `${dup.name} `, h('span', { className: 'font-bold' }, `Ã—${dup.count}`))
                                                ),
                                                duplicateWarning.duplicates.length > 10 && h('span', { className: 'text-gray-600' }, `...è¿˜æœ‰ ${duplicateWarning.duplicates.length - 10} ä¸ªé‡å`)
                                            )
                                        )
                                    )
                                ),
                                enableDedup && h('div', { className: 'mt-3 pt-3 border-t border-yellow-200' },
                                    h('p', { className: 'text-xs text-yellow-800' }, 'ğŸ’¡ ', h('strong', {}, 'æç¤ºï¼š'), 'å¦‚æœè¿™äº›æ˜¯ä¸åŒçš„äººï¼ˆä¾‹å¦‚ä¸åŒç­çº§çš„åŒåå­¦ç”Ÿï¼‰ï¼Œè¯·è¿”å›ä¸Šä¸€æ­¥ï¼Œå–æ¶ˆå‹¾é€‰"è‡ªåŠ¨å»é‡"é€‰é¡¹ï¼Œæˆ–åœ¨Excelä¸­ä¸ºå§“åæ·»åŠ åŒºåˆ†æ ‡è¯†ï¼ˆå¦‚"å¼ ä¼Ÿ-1ç­"ï¼‰ã€‚')
                                )
                            ),
                            h('div', { className: 'mb-6 p-4 border rounded-lg bg-gray-50 max-h-96 overflow-y-auto' },
                                h('div', { className: 'flex items-center justify-between mb-3' },
                                    h('h3', { className: 'font-semibold text-sm text-gray-700' }, 'å§“ååˆ—è¡¨'),
                                    h('button', { onClick: downloadNamesAsTxt, className: 'flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition' }, h(Icons.Download, { size: 16 }), 'ä¸‹è½½TXT')
                                ),
                                h('div', { className: 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2' },
                                    allNames.map((name, idx) => h('div', { key: idx, className: 'px-3 py-2 bg-white rounded-lg text-center shadow-sm' }, name))
                                )
                            ),
                            h('div', { className: 'flex space-x-4' },
                                h('button', { onClick: () => setStep(fileType === 'txt' ? 1 : 2), className: 'px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition', disabled: generating }, 'ä¸Šä¸€æ­¥'),
                                h('button', {
                                    onClick: handleGenerate,
                                    disabled: generating,
                                    className: 'flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 flex items-center justify-center'
                                }, generating ? [h('div', { key: 'spinner', className: 'animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2' }), 'ç”Ÿæˆä¸­...'] : [h(Icons.Download, { key: 'icon', size: 20, className: 'mr-2' }), 'ç”Ÿæˆè¯ä¹¦æ–‡æ¡£'])
                            ),
                            h('div', { className: 'mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg' },
                                h('p', { className: 'text-sm text-yellow-800' }, 'âš ï¸ ', h('strong', {}, 'é‡è¦ï¼š'), 'è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ ', h('code', { className: 'bg-yellow-100 px-2 py-1 rounded' }, 'python app.py'), 'ï¼‰')
                            )
                        ),
                        step === 4 && h('div', { className: 'text-center' },
                            h(Icons.CheckCircle, { size: 64, className: 'mx-auto mb-4 text-green-600' }),
                            h('h2', { className: 'text-2xl font-bold mb-4' }, 'ç”Ÿæˆå®Œæˆï¼'),
                            h('p', { className: 'text-gray-600 mb-2' }, 'è¯ä¹¦æ–‡æ¡£å·²æˆåŠŸä¸‹è½½'),
                            h('p', { className: 'text-sm text-gray-500 mb-6' }, `åŒ…å« ${allNames.length} ä¸ªè¯ä¹¦é¡µé¢`),
                            h('button', {
                                onClick: () => {
                                    setStep(1);
                                    setFiles([]);
                                    setFileType('');
                                    setSheets([]);
                                    setSelectedSheets({});
                                    setAllNames([]);
                                    setManualMode(false);
                                    setEnableDedup(true);
                                    setDuplicateWarning(null);
                                },
                                className: 'px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition'
                            }, 'ç”Ÿæˆæ›´å¤šè¯ä¹¦')
                        )
                    ),
                    h('div', { className: 'mt-8 bg-white rounded-xl shadow-lg p-6' },
                        h('h3', { className: 'font-bold text-lg mb-3 flex items-center' }, h(Icons.FileText, { size: 20, className: 'mr-2 text-indigo-600' }), 'ä½¿ç”¨è¯´æ˜'),
                        h('ol', { className: 'space-y-2 text-sm text-gray-700' },
                            h('li', {}, h('strong', {}, '1.'), ' ä¸Šä¼ åŒ…å«å§“åçš„æ–‡ä»¶ï¼ˆæ”¯æŒå¤šä¸ªExcelæˆ–å•ä¸ªTXTï¼‰'),
                            h('li', {}, h('strong', {}, '2.'), ' Excelï¼šç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å§“ååˆ—ï¼Œå¯åˆ‡æ¢æ‰‹åŠ¨æ¨¡å¼è°ƒæ•´'),
                            h('li', {}, h('strong', {}, '3.'), ' TXTï¼šæ¯è¡Œä¸€ä¸ªå§“åï¼Œç›´æ¥æå–'),
                            h('li', {}, h('strong', {}, '4.'), ' ç¡®è®¤å§“ååˆ—è¡¨åç”Ÿæˆè¯ä¹¦æ–‡æ¡£')
                        ),
                        h('div', { className: 'mt-4 p-3 bg-blue-50 rounded-lg' },
                            h('p', { className: 'text-xs text-blue-800' }, 'ğŸ’¡ ', h('strong', {}, 'æ™ºèƒ½è¯†åˆ«å…³é”®è¯ï¼š'), 'å§“åã€nameã€åå­—ã€åç§°ã€å­¦ç”Ÿå§“åã€å­¦ç”Ÿã€äººå‘˜ã€å‘˜å·¥')
                        )
                    )
                )
            );
        }

        ReactDOM.render(h(CertificateGenerator), document.getElementById('root'));
    </script>
</body>

</html>